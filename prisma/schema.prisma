generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Users {
  id         String         @id @default(uuid())
  email      String         @unique
  password   String?
  membership User_Tenants[]
}

model Tenants {
  id           String         @id @default(uuid())
  name         String         @unique
  domain       String         @unique
  status       Tenant_status  @default(PENDING)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  members      User_Tenants[]
  invitations  invitations[]
  records      Records[]
  changeTracks Change_track[]
  anomalies    Anomaly[]

  @@index([status])
}

model Role {
  id   String    @id @default(uuid())
  role Role_type @default(USER)

  membership User_Tenants[]
}

model User_Tenants {
  id       String  @id @default(uuid())
  userId   String
  tenantId String
  roleId   String
  user     Users   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenants @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role     Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([userId, tenantId])
}

model invitations {
  id        String      @id @default(uuid())
  tenantId  String
  email     String
  status    Status_type @default(PENDING)
  token     String      @unique
  role      String
  expiresAt DateTime
  createdAt DateTime    @default(now())
  tenant    Tenants     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([tenantId])
}

model Records {
  id           String         @id @default(uuid())
  tenantId     String
  type         Record_type
  key          String
  value        Json
  version      Int            @default(1)
  createdAt    DateTime       @default(now())
  deleteAt     DateTime?
  tenant       Tenants        @relation(fields: [tenantId], references: [id])
  changeTracks Change_track[]

  anomalies Anomaly[]
}

model Change_track {
  id       String      @id @default(uuid())
  recordId String
  newval   Json
  oldval   Json
  action   Action_type
  tenantId String
  changeBy String
  time     DateTime    @default(now())
  tenant   Tenants     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  record   Records     @relation(fields: [recordId], references: [id])

  anomalies Anomaly[]
}

model Anomaly {
  id        String       @id @default(uuid())
  recordId  String
  tenantId  String
  trackId   String
  score     Float
  severity  AnomalySeverity
  reason    String
  createdAt DateTime     @default(now())
  record    Records      @relation(fields: [recordId], references: [id])
  tenant    Tenants      @relation(fields: [tenantId], references: [id])
  track     Change_track @relation(fields: [trackId], references: [id])

  @@index([tenantId])
  @@index([recordId])
  @@index([createdAt])
}

enum Role_type {
  ADMIN
  MANAGER
  USER
}

enum Status_type {
  PENDING
  ACCEPT
  EXPIRE
}

enum Tenant_status {
  PENDING
  ACCEPT
  REJECTED
}

enum Record_type {
  INVENTORY
  CONFIG
  PRICES
  LIMIT
}

enum Action_type {
  CREATE
  UPDATE
  DELETE
  ROLLBACK
}

enum AnomalySeverity {
  LOW
  MEDIUM
  HIGH
}